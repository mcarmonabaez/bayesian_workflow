---
title: "Primer intento estimación de participación nacional"
output: html_notebook
---


```{r, message = FALSE}
library(tidyverse)
library(rstan)

#preparar datos
load("data/nal_2012.rda")

# usamos los datos de los resultados finales de 2012
muestra_part <- nal_2012 %>% 
  dplyr::select(casilla_id, estrato, edo_id, tipo_casilla = casilla,
                total_votos = total, ln_total)
```



```{r, fig.width = 5, fig.height = 3, message = FALSE}

# resumen marco por estrato
resumen_estratos <- muestra_part %>% 
  group_by(estrato) %>% 
  summarise(n_casillas = n(),
            listado_nominal = sum(ln_total))

ggplot(resumen_estratos, aes(x = n_casillas)) + 
  geom_histogram(binwidth = 10, colour = 'white', fill = '#652b64', alpha = 0.8) +
  theme_light() +
  labs(title = "Número de casillas por estrato",
       x = 'Número de casillas',
       y = 'Frecuencia')


```

## Definir observaciones

```{stan, eval = FALSE}
data {
  int num_estratos;
  int n[num_estratos]; // num casillas por estrato 
  int N; // num casillas total
  int est[N]; // indicador de estrato para cada casilla 
  int y[N]; // conteos en cada casilla
}
```


## Conocimiento previo



```{r,  fig.width = 4, fig.height = 2, message = FALSE}
part <- seq(0, 1, 0.001)
dens_previa <- data.frame(part = part,
                          dens = dbeta(part, 6, 6))

dens_previa %>%
  ggplot(aes(x = part, y = dens)) +
  geom_line(colour = "#652b64") +
  geom_area(aes(x = ifelse(part > 0.2 & part < 0.8, part, 0)),
            alpha = 0.75, fill = "#652b64") +
  labs(x = "x", y = "densidad") +
  ylim(0,3) +
  theme_minimal()
```

```{r,  fig.width = 4, fig.height = 2, message = FALSE}

disp_previa <- data.frame(disp = abs(rnorm(1000,0, 0.15)))

disp_previa %>%
  ggplot(aes(x = disp)) +
  geom_density(colour = "#652b64") +
  labs(x = "x", y = "densidad") +
  theme_minimal()
```



```{r}
writeLines(readLines("src/stan_files/mod01_part.stan"))
```

```{r}
iter <- 100
sim_data <- list(k = length(unique(muestra_part$estrato)),
                 N = nrow(muestra_part), est = muestra_part$estrato, 
                 votantes_nom = muestra_part$ln_total)
muestras <- stan(file = "src/stan_files/mod01_part.stan", data = sim_data,
                 iter = iter, warmup = 0, chains = 1, refresh = iter,
                 seed = 232334, algorithm = "Fixed_param",
                 pars = c("y", "prop", "part_est", "part"))

saveRDS(muestras, "doc/muestras.rds")
muestras <- read_rds('doc/muestras.rds')
```

```{r}
sim_prop <- rstan::extract(muestras)$prop %>% as.numeric()
sim_part <- rstan::extract(muestras)$part %>% as.numeric()
sim_y <- rstan::extract(muestras)$y
tibble(prop = sim_prop) %>% 
  ggplot(aes(sample = prop)) +
  geom_qq(distribution = stats::qunif) +
  geom_abline(slope = 1, intercept = 0)
quantile(sim_prop, c(0.05, 0.5, 0.95))
```

```{r, fig.width=6, fig.height=4}
dim(sim_y)
dat <- as_tibble(t(sim_y[1:15,]), .name_repair = "unique") %>% 
  mutate(id = 1:143132) %>% gather(rep, votos, - id)
ggplot(dat, aes(x = votos)) + facet_wrap( ~rep) +
   geom_histogram()
```


```{r}
modelo <- stan_model("src/stan_files/mod01_part_ajuste.stan")
ajustar_sims <- function(iteracion, modelo, chains = 3){
  datos_sim_2 <- muestra_part %>% mutate(y = sim_y[iteracion, ])
  muestra_sim <- muestra_part %>% left_join(datos_sim_2 %>% select(-ln_total))
  data <- list(k = length(unique(muestra_part$estrato)), 
               N = nrow(muestra_part), n = nrow(muestra_sim), est = muestra_part$estrato, 
             est_muestra = muestra_sim$estrato,
                 votantes_nom = muestra_part$ln_total, y = muestra_sim$y,
             votantes_nom_muestra = muestra_sim$ln_total)
  ajuste <- sampling(modelo, data = data,
                 warmup = 400, iter = 1500,  chains = chains, 
                 thin = 3, 
                 pars = c("part", "phi_total"))
  sims_comp <- rstan::extract(ajuste)
  sims_comp
}
iteracion <- 1
sims_comp <- ajustar_sims(iteracion, modelo)
ggplot(tibble(part = sims_comp$part), aes(sample = part)) + geom_qq() +
  geom_hline(yintercept = sim_part[iteracion])
```


## Ajuste con datos reales


```{r}
muestra_part <- muestra_part %>% 
  mutate(ln = ifelse(ln_total < total_votos, total_votos, ln_total))
data <- list(k = length(unique(muestra_part$estrato)), 
             N = nrow(muestra_part), n = nrow(muestra_part), est = muestra_part$estrato, 
             est_muestra = muestra_part$estrato,
             votantes_nom = muestra_part$ln, y = muestra_part$total_votos,
             votantes_nom_muestra = muestra_part$ln)
ajuste <- stan(file = "src/stan_files/mod01_part_ajuste.stan", data = data,
                 warmup = 300, iter = 1500,  chains = 3, 
                 pars = c("part", "phi_total"))
```


```{r}
summary(ajuste)
plot(ajuste, pars = c("part"))
```

## Posterior predictive checks

```{r}
ajuste_pp <- stan(file = "src/stan_files/mod01_part_ppc.stan", data = data,
                 warmup = 100, iter = 1000,  chains = 1, 
                 pars = c("y_sim"))
sims_comp <- rstan::extract(ajuste_pp)

```